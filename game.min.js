function Player(a,b){this.spawned=null===b?!1:b;this.parts=[];this.nickName=a}Player.prototype.getNickname=function(){return this.nickName};Player.prototype.addPart=function(a,b){this.parts.push({x:a,y:b})};Player.prototype.setPart=function(a,b,c){this.parts[a].x=b;this.parts[a].y=c};Player.prototype.getParts=function(){return this.parts};Player.prototype.getPart=function(a){return this.parts[a]};Player.prototype.getPartCount=function(){return this.parts.length};Player.prototype.setHeadPart=function(a,b){this.setPart(0,a,b)};Player.prototype.getHeadPart=function(){return this.getPart(0)};Player.prototype.isSpawned=function(){return this.spawned};Player.prototype.setSpawned=function(a){this.spawned=a};var PacketHeader={AUTH_REQUEST:0,AUTH_RESPONSE:1,CRITICAL_ERROR:2,INITIAL_INFO_REQUEST:3,INITIAL_INFO_RESPONSE:4,TICK_INFO:5,DIRECTION_CHANGE:6,PLAYER_JOIN:7,PLAYER_SPAWN:8,PLAYER_LEAVE:9},connection,nickName,canvasCtx,textures={},players={},gameStarted=!1;function onOpen(){}function onMessage(a){a=new Uint8Array(a.data);switch(a[0]){case PacketHeader.TICK_INFO:onTick(a.subarray(1));break;case PacketHeader.PLAYER_SPAWN:onPlayerSpawn(a.subarray(1));break;case PacketHeader.PLAYER_JOIN:onPlayerJoin(a.subarray(1));break;case PacketHeader.PLAYER_LEAVE:onPlayerLeave(a.subarray(1));break;case PacketHeader.AUTH_REQUEST:onAuthRequest();break;case PacketHeader.INITIAL_INFO_REQUEST:onInitialInfo(a.subarray(1));break;case PacketHeader.CRITICAL_ERROR:onError({message:String.fromCharCode.apply(null,a.subarray(1))})}}function onTick(a){if(gameStarted){for(var b=1,c=0;c<a[0];++c)a[b+1]&1&&(processTickForPlayer({player:players[a[b]],newX:a[b+2],newY:a[b+3]}),b+=2),b+=2;updateGraphics(canvasCtx)}}function onPlayerSpawn(a){for(var b=(new Uint32Array(a.subarray(1,5)))[0],c=0;c<b;++c)players[a[0]].addPart(a[5+2*c],a[2*c+6]);players[a[0]].setSpawned(!0)}function onPlayerJoin(a){debug("Player joined: "+String.fromCharCode.apply(null,a.subarray(2,2+a[1]))+"("+a[0]+")");players[a[0]]=new Player(String.fromCharCode.apply(null,a.subarray(2,2+a[1])))}function onPlayerLeave(a){debug("Player left: "+players[a[0]].getNickname());delete players[a[0]]}function onAuthRequest(a){a=stringToOctetArray(nickName);connection.send(new Uint8Array([PacketHeader.AUTH_RESPONSE,a.length].concat(a)));canvasCtx=initializeGraphics();drawBackground(canvasCtx)}function onInitialInfo(a){for(var b=1,c=0;c<a[0];++c){var e=a[b];players[e]=new Player(String.fromCharCode.apply(null,a.subarray(b+2,b+2+a[b+1])),a[2+a[b+1]]);var b=b+(2+a[b+1]+1),f=(new Uint32Array(a.subarray(b,b+4)))[0],b=b+4,d;for(d=0;d<f;d++)players[e].addPart(a[b+2*d],a[b+2*d+1]);b+=2*d}loadTextures(canvasCtx)}function processTickForPlayer(a){if(a.newX!=a.player.getHeadPart().x||a.newY!=a.player.getHeadPart().y){canvasCtx.drawImage(textures.tile,1+8*a.player.getPart(a.player.getPartCount()-1).x,1+8*a.player.getPart(a.player.getPartCount()-1).y);for(var b=a.player.getPartCount()-1;0!==b;--b)a.player.setPart(b,a.player.getPart(b-1).x,a.player.getPart(b-1).y);a.player.setHeadPart(a.newX,a.newY)}}function onClose(){debug("server closed connection");gameStarted=!1}function onError(a){alert("Error: "+a.message)}function stringToOctetArray(a){for(var b=[],c=0;c<a.length;++c)b.push(a.charCodeAt(c));return b}function processButtonClick(a){"play"!=a.id||3>document.getElementById("nick").value.length||(nickName=document.getElementById("nick").value,connection=new WebSocket("ws://37.187.39.141:7777",["snkmp"]),connection.binaryType="arraybuffer",connection.onopen=onOpen,connection.onclose=onClose,connection.onmessage=onMessage)}function initializeGraphics(){document.getElementById("main").innerHTML='<canvas id="canvas" width="513" height="513"/>';return document.getElementById("canvas").getContext("2d")}window.onkeydown=function(a){if(gameStarted)switch(a.keyCode){case 38:connection.send(new Uint8Array([PacketHeader.DIRECTION_CHANGE,0]));break;case 40:connection.send(new Uint8Array([PacketHeader.DIRECTION_CHANGE,1]));break;case 37:connection.send(new Uint8Array([PacketHeader.DIRECTION_CHANGE,2]));break;case 39:connection.send(new Uint8Array([PacketHeader.DIRECTION_CHANGE,3]))}};function drawBackground(a){a.fillStyle="rgb(196, 195, 210)";a.fillRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height)}function loadTextures(a){textures.tile=new Image(7,7);textures.tile.src="tile.png";textures.tile.onload=function(){drawTiles(a);updateGraphics(a);var b=new Uint8Array([PacketHeader.INITIAL_INFO_RESPONSE]);connection.send(b);gameStarted=!0}}function drawTiles(a){for(var b=0;64>b;++b)for(var c=0;64>c;++c)a.drawImage(textures.tile,1+8*c,1+8*b)}function updateGraphics(a){for(var b in players)if(players[b].isSpawned()){a.fillStyle="rgb(77, 77, 109)";for(var c in players[b].getParts())players[b].getParts().hasOwnProperty(c)&&a.fillRect(1+8*players[b].getPart(c).x,1+8*players[b].getPart(c).y,7,7)}}function debug(a){document.getElementById("debug").innerHTML=a};